# Правила авто-обнаружения

## Концепция

Авто-обнаружение позволяет простым устройствам (один WB-контрол = одно логическое устройство) работать без явного записи в конфиге. Система анализирует тип и единицу измерения WB-контрола и автоматически сопоставляет его с соответствующим DeviceType.

Это удобно для простых случаев: выключатель, датчик температуры, датчик влажности. Для составных устройств (термостат, RGB-лента), объединяющих контролы с нескольких модулей, **всегда** требуется явная запись в конфиге.

## Таблица авто-обнаружения

| Тип WB-контрола | Единица измерения | DeviceType | Категория | Описание |
|-----------------|-------------------|------------|-----------|----------|
| `switch` | — | `switch` | switch | Реле, выключатель |
| `range` | — | `dimmer` | light | Диммер (0-100%) |
| `temperature` | `°C` | `temperature_sensor` | sensor | Датчик температуры |
| `rel_humidity` | `%` | `humidity_sensor` | sensor | Датчик влажности |
| `power` | `W` | `power_sensor` | sensor | Датчик мощности |
| `voltage` | `V` | `voltage_sensor` | sensor | Датчик напряжения |
| `lux` | `lx` | `illuminance_sensor` | sensor | Датчик освещённости |
| `concentration` | `ppm` | — | — | Нет стандартного типа (расширяемо) |
| `pressure` | `mmHg` | — | — | Нет стандартного типа (расширяемо) |
| `value` | `V` | `voltage_sensor` | sensor | Датчик напряжения (при однозначном определении) |
| `value` | `%` | — | — | Неоднозначный маппинг |

Контролы, не попавшие в таблицу, игнорируются авто-обнаружением. Для них необходимо добавить запись в конфиг вручную или добавить новое правило.

## Правила и приоритеты

### 1. Конфиг имеет приоритет

Если контрол указан в конфиге, авто-обнаружение **не применяется**. Это позволяет переопределить автоматический маппинг.

Пример: реле `wb-mr6cu_97/K1` по умолчанию станет `switch`, но если оно указано в конфиге термостата как слот `is_heating`, оно будет частью термостата, а не отдельным выключателем.

### 2. Один контрол = одно устройство

Авто-обнаружение создаёт ровно одно логическое устройство на один WB-контрол. Идентификатор формируется автоматически:

```
auto_<device>_<control>
```

Например: `auto_wb-mr6cu_97_K2` для контрола `K2` устройства `wb-mr6cu_97`.

### 3. Тип контрола определяет DeviceType

Система использует поле `type` из метаданных WB-контрола (MQTT-топик `/devices/<device>/controls/<control>/meta/type`).

### 4. Единица измерения уточняет маппинг

Если тип контрола неоднозначен (например, `value`), единица измерения помогает определить DeviceType. Если однозначное соответствие найти не удаётся, контрол игнорируется.

### 5. Автоматическое именование

Для авто-обнаруженных устройств:
- `display_name` формируется из имени контрола: `<device>/<control>`
- `room` остаётся пустым

## Когда нужен явная запись в конфиге

Явная запись в конфиге **обязательна** в следующих случаях:

### Составные устройства

Устройства, объединяющие несколько контролов с разных модулей:

- **Термостат** — температурный датчик + реле + виртуальная уставка + режим
- **RGB-лента** — диммер + RGB-контроллер
- **Климатическая система** — множество датчиков + исполнительные устройства

### Переопределение типа

Когда авто-обнаруженный тип не подходит:

- Реле управляет шторами, а не светом → нужна запись с `type: cover`
- Датчик используется как часть составного устройства → нужна запись в конфиге

### Пользовательские метаданные

Когда нужно задать:

- `display_name` — человекочитаемое имя
- `room` — привязку к комнате

## Примеры

### Автоматическое обнаружение выключателя

WB-контрол:
```
/devices/wb-mr6cu_97/controls/K2/meta/type → switch
/devices/wb-mr6cu_97/controls/K2 → 0
```

Результат авто-обнаружения:
```
CanonicalDevice:
  id:           auto_wb-mr6cu_97_K2
  display_name: "wb-mr6cu_97/K2"
  type:         switch
  capabilities:
    on_off:     false
```

### Автоматическое обнаружение датчика температуры

WB-контрол:
```
/devices/wb-msw-v3_1/controls/Temperature/meta/type → temperature
/devices/wb-msw-v3_1/controls/Temperature → 23.5
```

Результат авто-обнаружения:
```
CanonicalDevice:
  id:           auto_wb-msw-v3_1_Temperature
  display_name: "wb-msw-v3_1/Temperature"
  type:         temperature_sensor
  properties:
    temperature: 23.5
```

### Ситуация: контрол уже в конфиге

WB-контрол `wb-mr6cu_97/K1` имеет тип `switch`, но он указан в конфиге как слот `is_heating` термостата.

Авто-обнаружение **не** создаёт для него отдельное устройство `switch`, так как контрол уже привязан через конфиг.

### Ситуация: неизвестный тип контрола

WB-контрол:
```
/devices/wb-msw-v3_1/controls/Sound Level/meta/type → sound_level
```

Тип `sound_level` отсутствует в таблице авто-обнаружения. Контрол игнорируется. Для его использования необходимо:

1. Добавить новый тип в `schema/wb-ext-bridge.schema.json`
2. Добавить правило в таблицу авто-обнаружения
3. Или добавить явную запись в конфиг
