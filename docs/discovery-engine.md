# Discovery Engine

Автоматическое обнаружение устройств Wiren Board и создание канонических устройств.

## Приоритеты

```
1. Связки (bindings[])        ← кросс-модульные + кастомные
2. Профили модулей            ← известные WB-модули
3. Поконтрольный фоллбэк      ← таблица type → DeviceType
   + overrides[]              ← применяются после discovery
```

Если контрол уже привязан на более высоком уровне, нижние уровни его не трогают.

## Профили модулей

Профиль описывает, как модель WB-устройства превращается в набор канонических устройств. Профиль знает структуру модуля и создаёт **составные устройства** (например, диммер = реле + канал яркости).

### Формат

```yaml
model: wb-mdm3                          # совпадает с префиксом MQTT-имени
vendor: Wiren Board
description: "3-канальный диммер"
aliases:                                 # альтернативные модели (опционально)
  - wb-mdm3-mini

devices:
  - name_template: "{module_title} Диммер {n}"
    type: dimmer
    repeat: 3                            # n = 1..3
    map:
      on_off: "K{n}"
      brightness: "Channel {n}"
```

Результат для MQTT-устройства `wb-mdm3_1` — 3 канонических устройства:
- `WB-MDM3 Диммер 1` (dimmer: K1 + Channel 1)
- `WB-MDM3 Диммер 2` (dimmer: K2 + Channel 2)
- `WB-MDM3 Диммер 3` (dimmer: K3 + Channel 3)

### Поля

| Поле | Описание |
|------|----------|
| `model` | Идентификатор модели в нижнем регистре |
| `aliases` | Альтернативные модели с идентичной структурой |
| `devices[].name_template` | Шаблон имени |
| `devices[].type` | Тип канонического устройства |
| `devices[].repeat` | Количество повторений (подставляет `{n}`) |
| `devices[].control` / `map` | Один слот или маппинг слотов на контролы |

Шаблонные переменные: `{n}`, `{module_title}`, `{device_name}`, `{address}`.

### Извлечение модели

Имена MQTT-устройств WB следуют конвенции `<модель>_<адрес>` (regex `^(.+?)_(\d+)$`). При поиске профиля проверяются и `model`, и `aliases`. Если имя не соответствует паттерну — профили не применяются.

## Поконтрольный фоллбэк

Если контрол не привязан ни через связку, ни через профиль — один контрол = одно каноническое устройство.

| Тип WB-контрола | Единица | DeviceType |
|-----------------|---------|------------|
| `switch` | — | `switch` |
| `range` | — | `dimmer` |
| `temperature` | `°C` | `temperature_sensor` |
| `rel_humidity` | `%` | `humidity_sensor` |
| `power` | `W` | `power_sensor` |
| `voltage` | `V` | `voltage_sensor` |
| `lux` | `lx` | `illuminance_sensor` |

Тип контрола берётся из MQTT-метаданных (`.../meta/type`). Единица измерения уточняет маппинг при неоднозначных типах (например, `value`). Контролы, не попавшие в таблицу, игнорируются.

## Исключения и переопределения

**Исключения** (`discovery.exclude`, `discovery.exclude_devices`) — контролы и целые MQTT-устройства, которые движок игнорирует. Связки имеют приоритет: контрол в `exclude` + в `bindings[]` обрабатывается по связке.

**Переопределения** (`overrides[]`) применяются после discovery — меняют тип или имя авто-обнаруженного устройства. Работают только для типов с одним обязательным слотом.

## Именование и идентификаторы

| Источник | Формат имени | Формат id |
|----------|-------------|-----------|
| Профиль | `name_template` из профиля | `{device_name}_{slug(type)}_{n}` |
| Фоллбэк | `{device}/{control}` | `auto_{device}_{control}` |
| Связка | `name` из конфига | slugify от `name` |
